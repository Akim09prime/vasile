
rules_version = '2';

// NOTE FOR DEVELOPERS:
// Firestore queries using multiple 'where' filters or a 'where' filter with an 'orderBy' on a different field
// require a composite index. This file documents the security rules, but the indexes themselves MUST be created
// in the Google Cloud / Firebase console.
//
// Required indexes for this application:
//
// 1. Collection: 'projects', Fields: [isPublished: Ascending, createdAt: Descending]
//    Purpose: Used by admins to fetch all projects, sorted by creation date.
//
// 2. Collection: 'projects', Fields: [categorySlug: Ascending, isPublished: Ascending, createdAt: Descending]
//    Purpose: Used by admins to fetch projects within a specific category, sorted by creation date.
//
// 3. Collection: 'project_summaries', Fields: [isPublished: Ascending, publishedAt: Descending]
//    Purpose: Used by the public API to fetch all published project summaries, sorted by publication date.
//
// 4. Collection: 'project_summaries', Fields: [categorySlug: Ascending, isPublished: Ascending, publishedAt: Descending]
//    Purpose: Used by the public API to fetch published summaries in a category, sorted by publication date.
//
// 5. Collection: 'project_summaries', Fields: [isPublished: Ascending, completedAt: Descending]
//    Purpose: New. For the public portfolio timeline. Fetch published projects sorted by completion date.
//

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.allowed == true;
    }

    match /admins/{uid} {
      allow list: if request.auth != null;
      allow get: if request.auth != null;
      // Allow first admin creation if collection is empty, secured by a server-side bootstrap key logic.
      allow create: if request.auth.uid == uid && size(get(/databases/$(database)/documents/admins).data) == 0;
      allow update, delete: if isAdmin();
    }
    
    match /adminTests/{docId} {
        allow write, delete: if isAdmin();
    }

    match /projects/{projectId} {
      // Admins can read everything. Public can read only published projects.
      allow get: if resource.data.isPublished == true || isAdmin();
      // Listing is an admin-only operation.
      allow list: if isAdmin();
      // All write operations are admin-only.
      allow create, update, delete: if isAdmin();
    }

    match /project_summaries/{projectId} {
      // Public users and server-side API can read summary documents.
      allow read: if true;
      // Public listing is allowed for the portfolio page.
      allow list: if true;
      // Write operations are restricted to admins to sync with the 'projects' collection.
      allow write: if isAdmin();
    }
    
    match /settings/{docId} {
      // All users can read settings for themes, navigation etc.
      allow read: if true;
      // Only admins can change settings.
      allow write: if isAdmin();
    }

    match /leads/{leadId} {
      // Anyone can create a lead (submit the quote form).
      allow create: if true;
      // Only admins can manage leads.
      allow read, list, update, delete: if isAdmin();
    }
    
    match /contactMessages/{messageId} {
       // Anyone can create a contact message.
      allow create: if true;
      // Only admins can manage messages.
      allow read, list, update, delete: if isAdmin();
    }
  }
}
